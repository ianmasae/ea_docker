services:
  mt5:
    build: .
    # No platform override — runs natively on ARM64 (Apple Silicon)
    # Hangover Wine runs natively on ARM64, FEX emulates x86_64 app code
    container_name: mt5-headless
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      # Mount your EA source files (read-only)
      - ../:/mnt/experts:ro
      # Persist Wine prefix with MT5 installation (survives restarts)
      - ./data/wine:/root/.wine
    healthcheck:
      test: ["CMD", "/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    # Shared memory for Wine/Xvfb
    shm_size: "256m"

    environment:
      - API_ENABLED=${API_ENABLED:-true}
      - API_PORT=${API_PORT:-8000}
      - BRIDGE_PORT=${BRIDGE_PORT:-15555}

    ports:
      # noVNC — browser-based GUI access at http://localhost:6080/vnc.html
      - "6080:6080"
      # Trading API server
      - "${API_PORT:-8000}:${API_PORT:-8000}"
      ## Uncomment for direct VNC client access (e.g. RealVNC, TigerVNC)
      # - "5900:5900"
